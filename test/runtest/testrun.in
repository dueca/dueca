#!/usr/bin/bash

@XVFB@ @DISPLAY@ -screen 0 @DISPLAYSIZE@x24 &
XVFBPID=$!
export DISPLAY=@DISPLAY@
export GDK_BACKEND=x11
export -n WAYLAND_DISPLAY

sleep 1
env -i DISPLAY=@DISPLAY@ \
    GDK_BACKEND=x11 \
    USER=${USER} HOME=${HOME} LC_ALL=en_US.UTF-8 PATH=${PATH} \
    dbus-launch --exit-with-session @WINDOWMANAGER@ &
sleep 1
env -i DISPLAY=@DISPLAY@ \
    GDK_BACKEND=x11 \
    USER=${USER} HOME=${HOME} LC_ALL=en_US.UTF-8 PATH=${PATH} \
    PYTHONPATH=${PYTHONPATH} LD_LIBRARY_PATH=${LD_LIBRARY_PATH} \
    timeout --kill-after=10 @TIMELIMIT@s \
    @Python_EXECUTABLE@ @CMAKE_CURRENT_SOURCE_DIR@/testrunner.py \
    --base @TESTRUN_BASE@ \
    --control @CMAKE_CURRENT_SOURCE_DIR@/@CONTROLFILE@.xml \
    --timelimit @PYTHONTIME@
RESULT=$?
sleep 1

kill ${XVFBPID}
exit ${RESULT}


